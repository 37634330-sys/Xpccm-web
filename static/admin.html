<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åå°ç®¡ç† - é…·ç›‘æ§</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        /* æ·±è‰²ä¸»é¢˜ï¼ˆé»˜è®¤ï¼‰ */
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-card: #1c2128;
            --bg-hover: #252d38;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --text-muted: #6e7681;
            --border-color: #30363d;
            --accent-green: #00a33c;
            --accent-red: #f85149;
            --accent-blue: #58a6ff;
            --accent-yellow: #d29922;
        }
        
        /* æµ…è‰²ä¸»é¢˜ */
        [data-theme="light"] {
            --bg-primary: #f6f8fa;
            --bg-secondary: #ffffff;
            --bg-card: #ffffff;
            --bg-hover: #f3f4f6;
            --text-primary: #1f2937;
            --text-secondary: #4b5563;
            --text-muted: #6b7280;
            --border-color: #e5e7eb;
            --accent-green: #00a33c;
            --accent-red: #dc2626;
            --accent-blue: #2563eb;
            --accent-yellow: #d97706;
        }
        
        [data-theme="light"] .card,
        [data-theme="light"] .login-box {
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        [data-theme="light"] .btn-secondary {
            background: #fff;
            border-color: #d1d5db;
        }
        
        [data-theme="light"] .btn-primary {
            color: #fff;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 24px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .header h1 {
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 10px 18px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary { background: var(--accent-green); color: #fff; }
        .btn-secondary { background: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border-color); }
        .btn-danger { background: var(--accent-red); color: #fff; }

        /* ç™»å½•é¡µ */
        .login-page {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }

        .login-box {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            border: 1px solid var(--border-color);
        }

        .login-title {
            text-align: center;
            margin-bottom: 32px;
        }

        .login-title h2 {
            font-size: 28px;
            margin-bottom: 8px;
        }

        .login-title p {
            color: var(--text-muted);
        }

        /* è¡¨å• */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            font-size: 14px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-green);
        }

        /* å¡ç‰‡ */
        .card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid var(--border-color);
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* æ ‡ç­¾é¡µ */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 16px;
        }

        .tab {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            background: transparent;
            color: var(--text-muted);
            border: none;
            transition: all 0.2s;
        }

        .tab:hover { color: var(--text-primary); }
        .tab.active { background: var(--bg-hover); color: var(--text-primary); }

        /* éšè— */
        .hidden { display: none !important; }

        /* é€šçŸ¥æ¸ é“åˆ—è¡¨ */
        .channel-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .channel-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }

        .channel-info h4 {
            font-size: 15px;
            margin-bottom: 4px;
        }

        .channel-info p {
            font-size: 12px;
            color: var(--text-muted);
        }

        .channel-actions {
            display: flex;
            gap: 8px;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        /* ç›‘æ§åˆ—è¡¨ */
        .monitor-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: 10px;
            border: 1px solid var(--border-color);
            margin-bottom: 12px;
        }

        .monitor-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 12px;
        }

        .monitor-status.online { background: var(--accent-green); }
        .monitor-status.offline { background: var(--accent-red); }

        .monitor-info {
            flex: 1;
        }

        .monitor-info h4 {
            font-size: 15px;
            margin-bottom: 4px;
        }

        .monitor-info p {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* æ¶ˆæ¯æç¤º */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            padding: 14px 20px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            z-index: 1000;
        }

        .toast.success { border-left: 4px solid var(--accent-green); }
        .toast.error { border-left: 4px solid var(--accent-red); }

        textarea.form-input {
            min-height: 150px;
            font-family: 'JetBrains Mono', monospace;
            resize: vertical;
        }

        .form-hint {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 6px;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }
    </style>
</head>
<body>
    <!-- ç™»å½•é¡µé¢ -->
    <div class="login-page" id="loginPage">
        <div class="login-box">
            <div class="login-title">
                <h2>ğŸ” åå°ç®¡ç†</h2>
                <p id="loginHint">è¯·ç™»å½•ç®¡ç†å‘˜è´¦å·</p>
            </div>
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label class="form-label">ç”¨æˆ·å</label>
                    <input type="text" class="form-input" id="loginUsername" value="admin" required>
                </div>
                <div class="form-group">
                    <label class="form-label">å¯†ç </label>
                    <input type="password" class="form-input" id="loginPassword" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;" id="loginBtn">ç™»å½•</button>
            </form>
        </div>
    </div>

    <!-- ç®¡ç†åå° -->
    <div class="container hidden" id="adminPage">
        <div class="header">
            <h1>âš™ï¸ åå°ç®¡ç†</h1>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="toggleTheme()" id="themeBtn" title="åˆ‡æ¢ä¸»é¢˜">ğŸŒ™</button>
                <a href="/" class="btn btn-secondary">â† è¿”å›å‰å°</a>
                <button class="btn btn-danger" onclick="logout()">é€€å‡ºç™»å½•</button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('monitors')">ğŸ“¡ ç›‘æ§ç®¡ç†</button>
            <button class="tab" onclick="switchTab('channels')">ğŸ”” é€šçŸ¥æ¸ é“</button>
            <button class="tab" onclick="switchTab('settings')">ğŸ¨ ç½‘ç«™è®¾ç½®</button>
            <button class="tab" onclick="switchTab('account')">ğŸ‘¤ è´¦å·å®‰å…¨</button>
        </div>

        <!-- ç›‘æ§ç®¡ç† -->
        <div class="tab-content" id="tab-monitors">
            <div class="card">
                <div class="card-title">
                    <span>ç›‘æ§é¡¹ç›®åˆ—è¡¨</span>
                    <button class="btn btn-primary btn-sm" onclick="openAddMonitor()" style="margin-left: auto;">+ æ·»åŠ ç›‘æ§</button>
                </div>
                <div id="monitorList">
                    <div class="empty-state">åŠ è½½ä¸­...</div>
                </div>
            </div>
            
            <!-- æ·»åŠ /ç¼–è¾‘ç›‘æ§è¡¨å• -->
            <div class="card hidden" id="monitorFormCard">
                <div class="card-title" id="monitorFormTitle">æ·»åŠ ç›‘æ§</div>
                <div class="form-group">
                    <label class="form-label">ç›‘æ§åç§° *</label>
                    <input type="text" class="form-input" id="monitorName" placeholder="ä¾‹å¦‚ï¼šæˆ‘çš„ç½‘ç«™">
                </div>
                <div class="form-group">
                    <label class="form-label">ç›‘æ§åœ°å€ *</label>
                    <input type="text" class="form-input" id="monitorTarget" placeholder="https://example.com">
                </div>
                <div class="form-group">
                    <label class="form-label">ç›‘æ§ç±»å‹</label>
                    <div style="display: flex; gap: 16px; flex-wrap: wrap; margin-top: 8px;">
                        <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                            <input type="checkbox" id="typeHttp" checked> HTTP(s) ç›‘æ§
                        </label>
                        <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                            <input type="checkbox" id="typeSsl"> SSL è¯ä¹¦ç›‘æ§
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">æ£€æµ‹é—´éš”ï¼ˆç§’ï¼‰</label>
                    <input type="number" class="form-input" id="monitorInterval" value="60" min="10">
                </div>
                <div class="form-group">
                    <label class="form-label">è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰</label>
                    <input type="number" class="form-input" id="monitorTimeout" value="30" min="5">
                </div>
                <div class="form-group">
                    <label class="form-label">é€šçŸ¥æ¸ é“</label>
                    <div id="notifyChannelSelect" style="margin-top: 8px;">
                        <div class="empty-state" style="padding: 12px;">æš‚æ— é€šçŸ¥æ¸ é“ï¼Œè¯·å…ˆæ·»åŠ </div>
                    </div>
                </div>
                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button class="btn btn-secondary" onclick="cancelMonitorForm()">å–æ¶ˆ</button>
                    <button class="btn btn-primary" onclick="saveMonitor()">ä¿å­˜</button>
                </div>
            </div>
        </div>

        <!-- é€šçŸ¥æ¸ é“ -->
        <div class="tab-content hidden" id="tab-channels">
            <div class="card">
                <div class="card-title">
                    <span>é€šçŸ¥æ¸ é“ç®¡ç†</span>
                    <button class="btn btn-primary btn-sm" onclick="openAddChannel()" style="margin-left: auto;">+ æ·»åŠ æ¸ é“</button>
                </div>
                <div id="channelList">
                    <div class="empty-state">åŠ è½½ä¸­...</div>
                </div>
            </div>

            <!-- æ·»åŠ æ¸ é“è¡¨å• -->
            <div class="card hidden" id="channelFormCard">
                <div class="card-title" id="channelFormTitle">æ·»åŠ é€šçŸ¥æ¸ é“</div>
                <div class="form-group">
                    <label class="form-label">æ¸ é“åç§° *</label>
                    <input type="text" class="form-input" id="channelName" placeholder="ä¾‹å¦‚ï¼šæˆ‘çš„Webhook">
                </div>
                <div class="form-group">
                    <label class="form-label">æ¸ é“ç±»å‹</label>
                    <select class="form-input" id="channelType" onchange="updateChannelHint()">
                        <option value="webhook">ğŸ”— Webhook</option>
                        <option value="email">ğŸ“§ é‚®ä»¶é€šçŸ¥</option>
                        <option value="wechat">ğŸ’¬ ä¼ä¸šå¾®ä¿¡</option>
                        <option value="telegram">âœˆï¸ Telegram</option>
                        <option value="bark">ğŸ“± Bark</option>
                        <option value="pushplus">ğŸ“¨ PushPlus</option>
                        <option value="serverchan">ğŸš Serveré…±</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">é…ç½® (JSON)</label>
                    <textarea class="form-input" id="channelConfig" placeholder='{"url": "https://your-webhook.com"}'></textarea>
                    <div class="form-hint" id="channelHint">
                        <div style="margin-top: 8px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; font-family: 'JetBrains Mono', monospace; font-size: 12px;">
                            <div style="color: var(--accent-green); margin-bottom: 8px;">ğŸ“‹ é…ç½®æ¨¡æ¿ï¼ˆç‚¹å‡»å¤åˆ¶ï¼‰ï¼š</div>
                            <pre id="configTemplate" onclick="copyTemplate()" style="cursor: pointer; margin: 0; white-space: pre-wrap; color: var(--text-secondary);">{"url": "https://your-webhook.com"}</pre>
                        </div>
                        <div style="margin-top: 12px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; font-size: 12px;">
                            <div style="color: var(--accent-blue); margin-bottom: 8px;">ğŸ“Œ é€šçŸ¥å˜é‡ï¼ˆå¯åœ¨Webhookä¸­ä½¿ç”¨ï¼‰ï¼š</div>
                            <div style="color: var(--text-muted); line-height: 1.8;">
                                <code style="background: var(--bg-hover); padding: 2px 6px; border-radius: 4px;">name</code> - ç›‘æ§åç§°<br>
                                <code style="background: var(--bg-hover); padding: 2px 6px; border-radius: 4px;">status</code> - çŠ¶æ€ (1=æ­£å¸¸, 0=æ•…éšœ)<br>
                                <code style="background: var(--bg-hover); padding: 2px 6px; border-radius: 4px;">message</code> - è¯¦ç»†ä¿¡æ¯<br>
                                <code style="background: var(--bg-hover); padding: 2px 6px; border-radius: 4px;">target</code> - ç›‘æ§åœ°å€<br>
                                <code style="background: var(--bg-hover); padding: 2px 6px; border-radius: 4px;">type</code> - ç›‘æ§ç±»å‹<br>
                                <code style="background: var(--bg-hover); padding: 2px 6px; border-radius: 4px;">time</code> - è§¦å‘æ—¶é—´
                            </div>
                        </div>
                    </div>
                </div>
                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button class="btn btn-secondary" onclick="cancelChannelForm()">å–æ¶ˆ</button>
                    <button class="btn btn-primary" onclick="saveChannel()">ä¿å­˜</button>
                </div>
            </div>
        </div>

        <!-- ç½‘ç«™è®¾ç½® -->
        <div class="tab-content hidden" id="tab-settings">
            <div class="card">
                <div class="card-title">ğŸ¨ ç½‘ç«™è®¾ç½®</div>
                <div class="form-group">
                    <label class="form-label">ç½‘ç«™æ ‡é¢˜</label>
                    <input type="text" class="form-input" id="siteTitle" placeholder="é…·ç›‘æ§">
                </div>
                <div class="form-group">
                    <label class="form-label">ç½‘ç«™å›¾æ ‡ (Emoji)</label>
                    <input type="text" class="form-input" id="siteIcon" placeholder="ğŸš€">
                </div>
                <div class="form-group">
                    <label class="form-label">é¡µè„šä½œè€…</label>
                    <input type="text" class="form-input" id="footerAuthor" placeholder="Xpccm">
                </div>
                <div class="form-group">
                    <label class="form-label">å¤‡æ¡ˆå·</label>
                    <input type="text" class="form-input" id="footerIcp" placeholder="äº¬ICPå¤‡xxxxxxxxå·">
                </div>
                <div class="form-group">
                    <label class="form-label">å¤‡æ¡ˆé“¾æ¥</label>
                    <input type="text" class="form-input" id="footerUrl" placeholder="https://beian.miit.gov.cn/">
                </div>
                <button class="btn btn-primary" onclick="saveSettings()">ä¿å­˜è®¾ç½®</button>
            </div>
        </div>

        <!-- è´¦å·å®‰å…¨ -->
        <div class="tab-content hidden" id="tab-account">
            <div class="card">
                <div class="card-title">ğŸ”’ ä¿®æ”¹å¯†ç </div>
                <div class="form-group">
                    <label class="form-label">åŸå¯†ç </label>
                    <input type="password" class="form-input" id="oldPassword">
                </div>
                <div class="form-group">
                    <label class="form-label">æ–°å¯†ç </label>
                    <input type="password" class="form-input" id="newPassword">
                </div>
                <div class="form-group">
                    <label class="form-label">ç¡®è®¤æ–°å¯†ç </label>
                    <input type="password" class="form-input" id="confirmPassword">
                </div>
                <button class="btn btn-primary" onclick="changePassword()">ä¿®æ”¹å¯†ç </button>
            </div>
        </div>
    </div>

    <div id="toastContainer"></div>

    <script>
        let authToken = localStorage.getItem('adminToken') || '';
        let editingChannelId = null;
        let needSetup = false;

        // Toastæ¶ˆæ¯
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // APIè¯·æ±‚
        async function api(url, method = 'GET', data = null) {
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                }
            };
            if (data) options.body = JSON.stringify(data);
            const response = await fetch(url, options);
            return response.json();
        }

        // ä¸»é¢˜åˆ‡æ¢
        function loadTheme() {
            const theme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', theme);
            updateThemeIcon(theme);
        }
        
        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme') || 'dark';
            const newTheme = current === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
        }
        
        function updateThemeIcon(theme) {
            const btn = document.getElementById('themeBtn');
            if (btn) {
                btn.textContent = theme === 'dark' ? 'ğŸŒ™' : 'â˜€ï¸';
            }
        }

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        async function checkAuth() {
            const result = await api('/api/auth/check');
            if (result.need_setup) {
                needSetup = true;
                document.getElementById('loginHint').textContent = 'é¦–æ¬¡ä½¿ç”¨ï¼Œè¯·è®¾ç½®ç®¡ç†å‘˜å¯†ç ';
                document.getElementById('loginBtn').textContent = 'åˆ›å»ºç®¡ç†å‘˜';
            }
            if (result.authenticated) {
                showAdminPage();
            }
        }

        // ç™»å½•å¤„ç†
        async function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;

            if (needSetup) {
                const result = await api('/api/auth/setup', 'POST', { username, password });
                if (result.success) {
                    showToast('ç®¡ç†å‘˜åˆ›å»ºæˆåŠŸï¼Œè¯·ç™»å½•', 'success');
                    needSetup = false;
                    document.getElementById('loginHint').textContent = 'è¯·ç™»å½•ç®¡ç†å‘˜è´¦å·';
                    document.getElementById('loginBtn').textContent = 'ç™»å½•';
                } else {
                    showToast(result.error, 'error');
                }
                return;
            }

            const result = await api('/api/auth/login', 'POST', { username, password });
            if (result.success) {
                authToken = result.token;
                localStorage.setItem('adminToken', authToken);
                showAdminPage();
            } else {
                showToast(result.error, 'error');
            }
        }

        // æ˜¾ç¤ºç®¡ç†é¡µé¢
        function showAdminPage() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('adminPage').classList.remove('hidden');
            loadMonitors();
            loadChannels();
            loadChannelsForSelect();
            loadSettings();
        }

        // é€€å‡ºç™»å½•
        async function logout() {
            await api('/api/auth/logout', 'POST');
            authToken = '';
            localStorage.removeItem('adminToken');
            location.reload();
        }

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            event.target.classList.add('active');
            document.getElementById('tab-' + tab).classList.remove('hidden');
        }

        // ========== ç›‘æ§ç®¡ç† ==========
        let editingMonitorId = null;
        let allChannels = [];

        async function loadMonitors() {
            const result = await api('/api/monitors');
            const container = document.getElementById('monitorList');
            
            if (!result.monitors || result.monitors.length === 0) {
                container.innerHTML = '<div class="empty-state">æš‚æ— ç›‘æ§é¡¹ç›®</div>';
                return;
            }

            container.innerHTML = result.monitors.map(m => `
                <div class="monitor-item">
                    <div class="monitor-status ${m.current_status ? 'online' : 'offline'}"></div>
                    <div class="monitor-info">
                        <h4>${m.name}</h4>
                        <p>${m.target}</p>
                    </div>
                    <div class="channel-actions">
                        <button class="btn btn-secondary btn-sm" onclick="editMonitor(${m.id})">ç¼–è¾‘</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteMonitor(${m.id})">åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
        }

        async function loadChannelsForSelect() {
            const result = await api('/api/notify-channels');
            allChannels = result.channels || [];
            renderChannelSelect([]);
        }

        function renderChannelSelect(selectedIds) {
            const container = document.getElementById('notifyChannelSelect');
            if (allChannels.length === 0) {
                container.innerHTML = '<div style="color: var(--text-muted); font-size: 13px;">æš‚æ— é€šçŸ¥æ¸ é“ï¼Œè¯·å…ˆåœ¨ã€Œé€šçŸ¥æ¸ é“ã€ä¸­æ·»åŠ </div>';
                return;
            }
            container.innerHTML = allChannels.map(c => `
                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; cursor: pointer;">
                    <input type="checkbox" class="notify-channel-cb" value="${c.id}" ${selectedIds.includes(c.id) ? 'checked' : ''}>
                    <span>${c.name}</span>
                    <span style="color: var(--text-muted); font-size: 12px;">(${c.type})</span>
                </label>
            `).join('');
        }

        function openAddMonitor() {
            editingMonitorId = null;
            document.getElementById('monitorFormTitle').textContent = 'æ·»åŠ ç›‘æ§';
            document.getElementById('monitorName').value = '';
            document.getElementById('monitorTarget').value = '';
            document.getElementById('typeHttp').checked = true;
            document.getElementById('typeSsl').checked = false;
            document.getElementById('monitorInterval').value = '60';
            document.getElementById('monitorTimeout').value = '30';
            renderChannelSelect([]);
            document.getElementById('monitorFormCard').classList.remove('hidden');
        }

        async function editMonitor(id) {
            editingMonitorId = id;
            const result = await api(`/api/monitors/${id}`);
            if (!result.id) {
                showToast('åŠ è½½å¤±è´¥', 'error');
                return;
            }
            
            document.getElementById('monitorFormTitle').textContent = 'ç¼–è¾‘ç›‘æ§';
            document.getElementById('monitorName').value = result.name || '';
            document.getElementById('monitorTarget').value = result.target || '';
            
            const types = result.types || ['http'];
            document.getElementById('typeHttp').checked = types.includes('http');
            document.getElementById('typeSsl').checked = types.includes('ssl');
            
            document.getElementById('monitorInterval').value = result.interval || 60;
            document.getElementById('monitorTimeout').value = result.timeout || 30;
            
            const channelIds = result.notify_channels || [];
            renderChannelSelect(channelIds);
            
            document.getElementById('monitorFormCard').classList.remove('hidden');
        }

        function cancelMonitorForm() {
            document.getElementById('monitorFormCard').classList.add('hidden');
        }

        async function saveMonitor() {
            const name = document.getElementById('monitorName').value.trim();
            const target = document.getElementById('monitorTarget').value.trim();
            
            if (!name || !target) {
                showToast('è¯·å¡«å†™ç›‘æ§åç§°å’Œåœ°å€', 'error');
                return;
            }
            
            const types = [];
            if (document.getElementById('typeHttp').checked) types.push('http');
            if (document.getElementById('typeSsl').checked) types.push('ssl');
            
            if (types.length === 0) {
                showToast('è¯·è‡³å°‘é€‰æ‹©ä¸€ç§ç›‘æ§ç±»å‹', 'error');
                return;
            }
            
            const notifyChannels = [];
            document.querySelectorAll('.notify-channel-cb:checked').forEach(cb => {
                notifyChannels.push(parseInt(cb.value));
            });
            
            const data = {
                name,
                target,
                types,
                interval: parseInt(document.getElementById('monitorInterval').value) || 60,
                timeout: parseInt(document.getElementById('monitorTimeout').value) || 30,
                notify_channels: notifyChannels
            };
            
            let result;
            if (editingMonitorId) {
                result = await api(`/api/monitors/${editingMonitorId}`, 'PUT', data);
            } else {
                result = await api('/api/monitors', 'POST', data);
            }
            
            if (result.success || result.id) {
                showToast(editingMonitorId ? 'ä¿®æ”¹æˆåŠŸ' : 'æ·»åŠ æˆåŠŸ', 'success');
                cancelMonitorForm();
                loadMonitors();
            } else {
                showToast(result.error || 'ä¿å­˜å¤±è´¥', 'error');
            }
        }

        async function deleteMonitor(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç›‘æ§é¡¹ç›®å—ï¼Ÿ')) return;
            const result = await api(`/api/monitors/${id}`, 'DELETE');
            if (result.success) {
                showToast('åˆ é™¤æˆåŠŸ', 'success');
                loadMonitors();
            } else {
                showToast(result.error || 'åˆ é™¤å¤±è´¥', 'error');
            }
        }

        // ========== é€šçŸ¥æ¸ é“ ==========
        async function loadChannels() {
            const result = await api('/api/notify-channels');
            const container = document.getElementById('channelList');
            
            if (!result.channels || result.channels.length === 0) {
                container.innerHTML = '<div class="empty-state">æš‚æ— é€šçŸ¥æ¸ é“</div>';
                return;
            }

            container.innerHTML = result.channels.map(c => `
                <div class="channel-item">
                    <div class="channel-info">
                        <h4>${c.name}</h4>
                        <p>${c.type}</p>
                    </div>
                    <div class="channel-actions">
                        <button class="btn btn-secondary btn-sm" onclick="testChannel(${c.id})">æµ‹è¯•</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteChannel(${c.id})">åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
        }

        // æ¸ é“é…ç½®æ¨¡æ¿
        const channelTemplates = {
            webhook: {
                template: '{\n  "url": "https://your-webhook-url.com/notify"\n}',
                desc: 'Webhookä¼šæ”¶åˆ°åŒ…å«ç›‘æ§ä¿¡æ¯çš„JSONæ•°æ®'
            },
            email: {
                template: '{\n  "smtp_host": "smtp.qq.com",\n  "smtp_port": 465,\n  "smtp_user": "your-email@qq.com",\n  "smtp_pass": "æˆæƒç ",\n  "from_email": "your-email@qq.com",\n  "to_email": "receive@example.com",\n  "use_ssl": true\n}',
                desc: 'ä½¿ç”¨SMTPå‘é€é‚®ä»¶é€šçŸ¥ï¼ŒQQé‚®ç®±éœ€è¦ä½¿ç”¨æˆæƒç '
            },
            wechat: {
                template: '{\n  "webhook_url": "https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxx"\n}',
                desc: 'ä¼ä¸šå¾®ä¿¡ç¾¤æœºå™¨äººWebhookåœ°å€'
            },
            telegram: {
                template: '{\n  "bot_token": "123456:ABC-xxx",\n  "chat_id": "123456789"\n}',
                desc: 'Telegram Bot Token å’Œ Chat ID'
            },
            bark: {
                template: '{\n  "key": "your-bark-key",\n  "server": "https://api.day.app"\n}',
                desc: 'Barkæ¨é€å¯†é’¥ï¼ŒiOSè®¾å¤‡ä¸“ç”¨'
            },
            pushplus: {
                template: '{\n  "token": "your-pushplus-token"\n}',
                desc: 'PushPluså¾®ä¿¡æ¨é€Token'
            },
            serverchan: {
                template: '{\n  "sendkey": "your-sendkey"\n}',
                desc: 'Serveré…± SendKey'
            }
        };

        function updateChannelHint() {
            const type = document.getElementById('channelType').value;
            const template = channelTemplates[type];
            if (template) {
                document.getElementById('configTemplate').textContent = template.template;
            }
        }

        function copyTemplate() {
            const template = document.getElementById('configTemplate').textContent;
            document.getElementById('channelConfig').value = template;
            showToast('å·²å¤åˆ¶æ¨¡æ¿åˆ°é…ç½®æ¡†', 'success');
        }

        function openAddChannel() {
            editingChannelId = null;
            document.getElementById('channelFormTitle').textContent = 'æ·»åŠ é€šçŸ¥æ¸ é“';
            document.getElementById('channelName').value = '';
            document.getElementById('channelType').value = 'webhook';
            document.getElementById('channelConfig').value = '';
            document.getElementById('channelFormCard').classList.remove('hidden');
            updateChannelHint();
        }

        function cancelChannelForm() {
            document.getElementById('channelFormCard').classList.add('hidden');
        }

        async function saveChannel() {
            const name = document.getElementById('channelName').value;
            const type = document.getElementById('channelType').value;
            let config;
            
            try {
                config = JSON.parse(document.getElementById('channelConfig').value || '{}');
            } catch {
                showToast('é…ç½®JSONæ ¼å¼é”™è¯¯', 'error');
                return;
            }

            const result = await api('/api/notify-channels', 'POST', { name, type, config });
            if (result.success) {
                showToast('ä¿å­˜æˆåŠŸ', 'success');
                cancelChannelForm();
                loadChannels();
            } else {
                showToast(result.error || 'ä¿å­˜å¤±è´¥', 'error');
            }
        }

        async function testChannel(id) {
            const result = await api(`/api/notify-channels/${id}/test`, 'POST');
            if (result.success) {
                showToast('æµ‹è¯•é€šçŸ¥å·²å‘é€', 'success');
            } else {
                showToast('æµ‹è¯•å¤±è´¥', 'error');
            }
        }

        async function deleteChannel(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé€šçŸ¥æ¸ é“å—ï¼Ÿ')) return;
            const result = await api(`/api/notify-channels/${id}`, 'DELETE');
            if (result.success) {
                showToast('åˆ é™¤æˆåŠŸ', 'success');
                loadChannels();
            }
        }

        // ========== ç½‘ç«™è®¾ç½® ==========
        async function loadSettings() {
            const settings = await api('/api/settings');
            document.getElementById('siteTitle').value = settings.site_title || '';
            document.getElementById('siteIcon').value = settings.site_icon || '';
            document.getElementById('footerAuthor').value = settings.footer_author || '';
            document.getElementById('footerIcp').value = settings.footer_icp || '';
            document.getElementById('footerUrl').value = settings.footer_url || '';
        }

        async function saveSettings() {
            const data = {
                site_title: document.getElementById('siteTitle').value,
                site_icon: document.getElementById('siteIcon').value,
                footer_author: document.getElementById('footerAuthor').value,
                footer_icp: document.getElementById('footerIcp').value,
                footer_url: document.getElementById('footerUrl').value
            };

            const result = await api('/api/settings', 'PUT', data);
            if (result.success) {
                showToast('è®¾ç½®ä¿å­˜æˆåŠŸ', 'success');
            } else {
                showToast(result.error || 'ä¿å­˜å¤±è´¥', 'error');
            }
        }

        // ========== ä¿®æ”¹å¯†ç  ==========
        async function changePassword() {
            const oldPassword = document.getElementById('oldPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (newPassword !== confirmPassword) {
                showToast('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´', 'error');
                return;
            }

            const result = await api('/api/auth/password', 'PUT', { old_password: oldPassword, new_password: newPassword });
            if (result.success) {
                showToast('å¯†ç ä¿®æ”¹æˆåŠŸ', 'success');
                document.getElementById('oldPassword').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';
            } else {
                showToast(result.error || 'ä¿®æ”¹å¤±è´¥', 'error');
            }
        }

        // åˆå§‹åŒ–
        loadTheme();
        checkAuth();
    </script>
</body>
</html>

